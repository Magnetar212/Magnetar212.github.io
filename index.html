<!DOCTYPE html>
<html>
<head>
  <title>Arduino Data</title>
  <script src="raphael-2.1.4.min.js"></script>
  <script src="justgage.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js" charset="utf-8"></script>
  <style>
    .container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .plot, .gauge {
      margin: 10px;
    }
    #statusBox {
      text-align: center;
      font-size: 1.5em;
      margin: 20px 0;
    }
    .controls {
      text-align: center;
      margin: 20px 0;
    }
  </style>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var gauge = new JustGage({
        id: "Pressure",
        value: 0.0,
        decimals: 2,
        min: 0.0,
        max: 1000.0,
        title: "Pressure (torr)"
      });

      var timeData = [];
      var pressureData = [];
      var layout = {
        title: 'Pressure Over Time',
        xaxis: { title: 'Time' },
        yaxis: { title: 'Pressure (torr)' }
      };
      Plotly.newPlot('livePlot', [{
        x: timeData,
        y: pressureData,
        type: 'line'
      }], layout);

      async function fetchData() {
        try {
          const response = await fetch('https://your-project-id.firebaseio.com/data.json'); // Replace with your Firebase database URL
          if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
          }
          const data = await response.json();
          console.log('Data received:', data);

          if (data && data.pressure) {
            const pressure = parseFloat(data.pressure);
            const currentTime = new Date().toLocaleTimeString();
            console.log('Pressure value:', pressure);
            if (!isNaN(pressure)) {
              console.log('Updating gauge value:', pressure);
              if (pressure < 0.1) {
                gauge.config.min = 0.0;
                gauge.config.max = 1000.0;
                gauge.config.decimals = 1;
                gauge.config.title = "Pressure (millitorr)";
                gauge.refresh(pressure * 1000);
              } else if (pressure < 1) {
                gauge.config.min = 0.0;
                gauge.config.max = 1000.0;
                gauge.config.decimals = 0;
                gauge.config.title = "Pressure (millitorr)";
                gauge.refresh(pressure * 1000);
              } else {
                gauge.config.min = 0.0;
                gauge.config.max = 1000.0;
                gauge.config.decimals = 2;
                gauge.config.title = "Pressure (torr)";
                gauge.refresh(pressure);
              }

              // Update the live plot graph
              timeData.push(currentTime);
              pressureData.push(pressure);
              Plotly.update('livePlot', {
                x: [timeData],
                y: [pressureData]
              });
            } else {
              console.error('Invalid pressure value:', data.pressure);
            }
          } else {
            console.error('Pressure value not found in data:', data);
          }

          document.getElementById('statusBox').innerText = 'Pumps Status: ' + (data.Pumps_Status ? 'On' : 'Off');
        } catch (error) {
          console.error('Error fetching data:', error);
        }
      }

      setInterval(fetchData, 10000); // Update gauge and plot every 10 seconds
    });

    function togglePin() {
      fetch('https://your-project-id.firebaseio.com/togglePin.json', { method: 'POST' }) // Implement toggle logic
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
          }
          console.log('Pin toggled successfully');
        })
        .catch(error => console.error('Error toggling pin:', error));
    }

    function setTargetPressure() {
      const targetPressure = document.getElementById('targetPressure').value;
      fetch('https://your-project-id.firebaseio.com/targetPressure.json', {
        method: 'PUT',
        body: JSON.stringify({ targetPressure: targetPressure }),
        headers: {
          'Content-Type': 'application/json'
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
          }
          console.log('Target pressure set successfully');
        })
        .catch(error => console.error('Error setting target pressure:', error));
    }
  </script>
</head>
<body>
  <h1 style="text-align: center;">Vacuum Chamber Data</h1>
  <div class="container">
    <div id="livePlot" class="plot" style="width:600px; height:400px;"></div> <!-- Live plot graph -->
    <div id="Pressure" class="gauge" style="width:400px; height:360px;"></div> <!-- Pressure gauge -->
  </div>
  <div id="statusBox"></div> <!-- Status box -->
  <div class="controls">
    <button onclick="togglePin()">Toggle Pin</button>
    <div>
      <label for="targetPressure">Set Target Pressure (torr):</label>
      <input type="number" id="targetPressure" name="targetPressure" step="0.01" value="500.0">
      <button onclick="setTargetPressure()">Set Pressure</button>
    </div>
  </div>
</body>
</html>
